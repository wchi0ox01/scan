<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบเช็คชื่อ - ลงทะเบียน / สแกน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 max-w-3xl">

  <header class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-blue-600">ระบบเช็คชื่อออนไลน์ (วิทยาลัย)</h1>
    <a href="admin.html" class="text-sm text-white bg-blue-600 px-3 py-2 rounded">หน้าแอดมิน</a>
  </header>

  <!-- TABS -->
  <div class="bg-white p-4 rounded shadow mb-4">
    <nav class="flex gap-2">
      <button id="tab-register-btn" class="px-3 py-2 bg-blue-600 text-white rounded">ลงทะเบียนครั้งแรก</button>
      <button id="tab-scan-btn" class="px-3 py-2 bg-transparent border rounded">สแกนเช็คชื่อ</button>
    </nav>
  </div>

  <!-- REGISTER -->
  <div id="register-section" class="bg-white p-6 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-3">ลงทะเบียนใช้งานครั้งแรก</h2>
    <form id="register-form" class="space-y-3">
      <div>
        <label class="block text-sm font-medium">ชื่อ-สกุล</label>
        <input id="reg-name" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium">รหัสประจำตัวนักศึกษา</label>
        <input id="reg-studentid" class="w-full border rounded p-2" required>
      </div>
      <div>
        <label class="block text-sm font-medium">ห้อง</label>
        <input id="reg-class" class="w-full border rounded p-2" required>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">ถ่ายรูปใบหน้า (ใช้กล้อง)</label>
        <div class="bg-gray-200 rounded overflow-hidden aspect-video mb-2">
          <video id="reg-video" autoplay playsinline class="w-full h-full object-cover"></video>
          <canvas id="reg-canvas" class="hidden"></canvas>
        </div>
        <div class="flex gap-2">
          <button type="button" id="start-cam-btn" class="px-3 py-2 bg-indigo-600 text-white rounded">เปิดกล้อง</button>
          <button type="button" id="capture-btn" class="px-3 py-2 bg-green-600 text-white rounded">ถ่ายภาพ</button>
          <button type="button" id="stop-cam-btn" class="px-3 py-2 bg-red-500 text-white rounded">ปิดกล้อง</button>
        </div>
        <p id="reg-capture-msg" class="text-sm text-green-600 mt-2"></p>
      </div>

      <div>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" id="reg-allow-location" class="rounded" />
          <span class="text-sm">อนุญาตให้เว็บขอตำแหน่ง (GPS)</span>
        </label>
      </div>

      <div class="flex justify-end">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">ลงทะเบียนและบันทึก</button>
      </div>
    </form>
  </div>

  <!-- SCAN -->
  <div id="scan-section" class="hidden bg-white p-6 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-3">สแกนเช็คชื่อ</h2>
    <p class="text-sm text-gray-600 mb-3">เวลาเช็คชื่อ: จันทร์–ศุกร์ 06:00–08:30 (ต้องอยู่ภายในบริเวณวิทยาลัย)</p>

    <div class="bg-black rounded overflow-hidden aspect-video mb-2 relative">
      <video id="scan-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
      <canvas id="scan-overlay" class="absolute inset-0"></canvas>
      <div id="scan-result" class="absolute top-2 left-2 bg-green-700 text-white px-3 py-1 rounded hidden"></div>
    </div>

    <div class="flex gap-2">
      <button id="start-scan" class="px-3 py-2 bg-blue-600 text-white rounded">เริ่มสแกน</button>
      <button id="stop-scan" class="px-3 py-2 bg-red-500 text-white rounded">หยุดสแกน</button>
    </div>

    <p id="scan-message" class="mt-3 text-sm text-red-600"></p>
  </div>

  <!-- HELPER INFO -->
  <div id="info" class="bg-white p-4 rounded shadow text-sm text-gray-600">
    <p>หลังลงทะเบียนครั้งแรก ระบบจะบันทึกข้อมูลใน Google Sheets และจำรหัสในเครื่อง (localStorage) ทำให้ครั้งต่อไปไม่ต้องกรอกข้อมูล — เปิดหน้า "สแกนเช็คชื่อ" แล้วกดเริ่มสแกน</p>
  </div>

</div>

<script>
/* ====== CONFIG ====== */
const GAS_URL = localStorage.getItem('gasWebAppUrl') || ''; // ต้องตั้งค่า GAS URL ใน console หรือตั้งค่าลงใน LocalStorage
const CENTER_LAT = 14.529033;
const CENTER_LNG = 100.907445;
const RADIUS_METERS = 50; // 50 เมตร
const CHECK_START_HOUR = 6; // 06:00
const CHECK_END_HOUR = 8;   // 08:30 -> handle minutes separately
const CHECK_END_MIN = 30;

/* ====== UTILITIES ====== */
function haversineDistance(lat1, lon1, lat2, lon2) {
  function toRad(x){return x*Math.PI/180;}
  const R = 6371000;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function inCheckTimeWindow(date = new Date()){
  const day = date.getDay(); // 0 Sun ... 6 Sat
  if (day === 0 || day === 6) return false;
  const h = date.getHours(), m = date.getMinutes();
  if (h < CHECK_START_HOUR) return false;
  if (h > CHECK_END_HOUR) return false;
  if (h === CHECK_END_HOUR && m > CHECK_END_MIN) return false;
  return true;
}

/* ====== FACE API MODELS ====== */
let faceMatcher = null;
let students = []; // loaded from GAS
async function loadModels() {
  const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
  ]);
}

/* ====== API CALL TO GAS ====== */
async function apiCall(payload) {
  if (!GAS_URL) {
    alert('กรุณาตั้งค่า Google Apps Script URL ใน localStorage โดยใช้ชื่อ key: gasWebAppUrl');
    throw new Error('GAS URL missing');
  }
  try {
    const res = await fetch(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
    return await res.json();
  } catch (e) {
    console.error(e); alert('ไม่สามารถเชื่อมต่อ Server ได้');
    return { success:false, error: e.message };
  }
}

/* ====== UI & NAV ====== */
const tabRegisterBtn = document.getElementById('tab-register-btn');
const tabScanBtn = document.getElementById('tab-scan-btn');
const registerSection = document.getElementById('register-section');
const scanSection = document.getElementById('scan-section');

tabRegisterBtn.onclick = () => { registerSection.classList.remove('hidden'); scanSection.classList.add('hidden'); tabRegisterBtn.classList.add('bg-blue-600','text-white'); tabScanBtn.classList.remove('bg-blue-600','text-white'); }
tabScanBtn.onclick = () => { registerSection.classList.add('hidden'); scanSection.classList.remove('hidden'); tabScanBtn.classList.add('bg-blue-600','text-white'); tabRegisterBtn.classList.remove('bg-blue-600','text-white'); }

/* ====== REGISTRATION (camera capture) ====== */
let regStream = null;
const regVideo = document.getElementById('reg-video');
const regCanvas = document.getElementById('reg-canvas');
document.getElementById('start-cam-btn').onclick = async () => {
  try {
    regStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' } });
    regVideo.srcObject = regStream;
  } catch (e) { alert('ไม่สามารถเปิดกล้องได้: ' + e.message); }
};
document.getElementById('stop-cam-btn').onclick = () => {
  if (regStream) { regStream.getTracks().forEach(t => t.stop()); regStream = null; regVideo.srcObject = null; }
};
document.getElementById('capture-btn').onclick = () => {
  if (!regVideo || !regVideo.videoWidth) { alert('กรุณาเปิดกล้องก่อนถ่ายภาพ'); return; }
  regCanvas.width = regVideo.videoWidth; regCanvas.height = regVideo.videoHeight;
  regCanvas.getContext('2d').drawImage(regVideo, 0, 0);
  const dataUrl = regCanvas.toDataURL('image/jpeg', 0.8);
  localStorage.setItem('reg_image', dataUrl);
  document.getElementById('reg-capture-msg').innerText = 'ถ่ายรูปเรียบร้อยแล้ว';
};

/* ====== REGISTER FORM SUBMIT ====== */
document.getElementById('register-form').onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById('reg-name').value.trim();
  const studentid = document.getElementById('reg-studentid').value.trim();
  const cls = document.getElementById('reg-class').value.trim();
  const allowLoc = document.getElementById('reg-allow-location').checked;
  const imageData = localStorage.getItem('reg_image');
  if (!name || !studentid || !cls || !imageData) { alert('กรุณากรอกข้อมูลให้ครบและถ่ายรูป'); return; }
  if (!allowLoc) { if (!confirm('ระบบแนะนำให้อนุญาตตำแหน่งเพื่อยืนยันพื้นที่สแกน คุณต้องการดำเนินการต่อโดยไม่เปิด GPS ไหม?')) return; }

  // get location if allowed (optional)
  let geo = null;
  if (allowLoc && navigator.geolocation) {
    try {
      geo = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p => res(p.coords), err => res(null), { enableHighAccuracy:true, timeout:10000 }));
    } catch(e){ geo = null; }
  }

  // send to server
  const payload = { action:'addStudent', data:{ id: studentid, name, class: cls, imageData } };
  const r = await apiCall(payload);
  if (r.success) {
    // store local copy & mark registered
    localStorage.setItem('student_registered', '1');
    localStorage.setItem('studentid', studentid);
    alert('ลงทะเบียนเรียบร้อยแล้ว คุณสามารถไปที่หน้า "สแกนเช็คชื่อ" เพื่อใช้งาน');
    tabScanBtn.click();
    // load students for recognition
    await loadStudentsAndBuildMatcher();
  } else {
    alert('เกิดข้อผิดพลาด: ' + (r.error || 'ไม่สำเร็จ'));
  }
};

/* ====== LOAD STUDENTS & BUILD FACE MATCHER ====== */
async function loadStudentsAndBuildMatcher() {
  try {
    const res = await apiCall({ action:'getStudents' });
    if (!res.success) { console.error('getStudents failed', res); return; }
    students = res.data || [];
    const labeled = [];
    for (const s of students) {
      if (s.imagedatabase64 && s.imagedatabase64.startsWith('data:image')) {
        try {
          const img = await faceapi.fetchImage(s.imagedatabase64);
          const det = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
          if (det) labeled.push(new faceapi.LabeledFaceDescriptors(s.studentid, [det.descriptor]));
        } catch(e){ console.warn('process student image', s.studentid, e); }
      }
    }
    if (labeled.length>0) faceMatcher = new faceapi.FaceMatcher(labeled, 0.6);
    else faceMatcher = null;
    console.log('faceMatcher ready', labeled.length);
  } catch (e) { console.error(e); }
}

/* ====== SCAN FLOW ====== */
let scanStream = null;
let scanInterval = null;
const scanVideo = document.getElementById('scan-video');
const scanOverlay = document.getElementById('scan-overlay');
const scanResult = document.getElementById('scan-result');
const scanMessage = document.getElementById('scan-message');

document.getElementById('start-scan').onclick = async () => {
  scanMessage.innerText = '';
  if (!faceapi.nets.faceRecognitionNet.params) {
    await loadModels();
    await loadStudentsAndBuildMatcher();
  }
  try {
    scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' } });
    scanVideo.srcObject = scanStream;
    scanVideo.onloadedmetadata = () => scanVideo.play();
    const ctx = scanOverlay.getContext('2d');

    // get current location once (for check)
    let coords = null;
    try {
      coords = await new Promise((res) => {
        if (!navigator.geolocation) return res(null);
        navigator.geolocation.getCurrentPosition(p => res(p.coords), err => res(null), { enableHighAccuracy:true, timeout:8000 });
      });
    } catch(e){ coords = null; }

    // check time window
    const now = new Date();
    if (!inCheckTimeWindow(now)) {
      scanMessage.innerText = 'หมดเวลาการเช็คชื่อแล้ว (เช็คได้เฉพาะ 06:00–08:30 จันทร์–ศุกร์)';
      return stopScan();
    }

    // check location
    if (!coords) {
      scanMessage.innerText = 'ไม่สามารถตรวจพิกัดได้ กรุณาเปิด GPS แล้วลองใหม่';
      return stopScan();
    }
    const dist = haversineDistance(coords.latitude, coords.longitude, CENTER_LAT, CENTER_LNG);
    if (dist > RADIUS_METERS) {
      scanMessage.innerText = 'ท่านอยู่นอกพื้นที่ (ไม่สามารถเช็คชื่อได้)';
      return stopScan();
    }

    scanInterval = setInterval(async () => {
      if (scanVideo.readyState < 2) return;
      const detections = await faceapi.detectAllFaces(scanVideo).withFaceLandmarks().withFaceDescriptors();
      const displaySize = { width: scanVideo.videoWidth, height: scanVideo.videoHeight };
      faceapi.matchDimensions(scanOverlay, displaySize);
      const resized = faceapi.resizeResults(detections, displaySize);
      ctx.clearRect(0,0,scanOverlay.width, scanOverlay.height);
      if (faceMatcher && resized.length>0) {
        for (let i=0;i<resized.length;i++) {
          const d = resized[i];
          const best = faceMatcher.findBestMatch(d.descriptor);
          const box = d.detection.box;
          ctx.strokeStyle = 'lime'; ctx.lineWidth = 2; ctx.strokeRect(box.x, box.y, box.width, box.height);
          ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(box.x, box.y-22, box.width, 22);
          ctx.fillStyle = 'white'; ctx.font = '16px sans-serif'; ctx.fillText(best.toString(), box.x+6, box.y-6);

          if (best.label !== 'unknown') {
            // found student id
            const matchedId = best.label;
            // get student record
            const stud = students.find(s => s.studentid === matchedId);
            if (stud) {
              // prepare attendance record
              const timestamp = new Date().toISOString();
              // compute status based on time (server will also compute)
              const rec = { id: stud.studentid, name: stud.name, class: stud.class, timestamp, location:`${coords.latitude},${coords.longitude}` };
              // compute on client for immediate feedback
              const nowLocal = new Date();
              const late = (nowLocal.getHours() > CHECK_END_HOUR || (nowLocal.getHours()===CHECK_END_HOUR && nowLocal.getMinutes()>CHECK_END_MIN)) ? true : false;
              rec.status = late ? 'มาสาย' : 'มาเรียน';

              // visual
              scanResult.innerText = `${stud.name} (${stud.studentid}) - เช็คชื่อสำเร็จ`;
              scanResult.classList.remove('hidden');
              scanMessage.innerText = '';

              // send to server (bulk or single)
              await apiCall({ action:'recordAttendance', data: rec });
              // stop after success to avoid duplicates
              clearInterval(scanInterval); scanInterval = null;
              setTimeout(() => { scanResult.classList.add('hidden'); stopScan(); }, 1500);
              return;
            }
          } else {
            scanMessage.innerText = 'ยังไม่รู้จักใบหน้านี้ในระบบ';
          }
        }
      } else {
        // no face or no matcher
      }
    }, 500);
  } catch(e) {
    console.error(e); alert('ไม่สามารถเปิดกล้องได้: ' + e.message);
  }
};

document.getElementById('stop-scan').onclick = stopScan;
function stopScan() {
  if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
  if (scanStream) { scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; scanVideo.srcObject=null; }
  scanResult.classList.add('hidden'); scanMessage.innerText = '';
}

/* ====== ON LOAD ====== */
window.addEventListener('load', async () => {
  // load models in background
  try { await loadModels(); } catch(e){ console.warn('model load fail', e); }
  // if already registered -> switch to scan tab
  if (localStorage.getItem('student_registered')) {
    tabScanBtn.click();
    await loadStudentsAndBuildMatcher();
  } else {
    tabRegisterBtn.click();
  }
});
</script>
</body>
</html>

